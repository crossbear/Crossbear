diff -r c3f49c169c97 -r 6b9e8012c1d0 Makefile.in
--- a/Makefile.in	Sun Oct 07 12:55:03 2012 +0200
+++ b/Makefile.in	Mon Dec 24 16:28:45 2012 +0100
@@ -55,7 +55,7 @@
 SED=@SED@
 ENT=@ENT@
 XAUTH_PATH=@XAUTH_PATH@
-LDFLAGS=-L. -Lopenbsd-compat/ @LDFLAGS@
+LDFLAGS=-L. -Lopenbsd-compat/ -Lnotary/ @LDFLAGS@
 EXEEXT=@EXEEXT@
 MANFMT=@MANFMT@
 
@@ -129,6 +129,10 @@
 .c.o:
 	$(CC) $(CFLAGS) $(CPPFLAGS) -c $<
 
+LIBNOTARY=notary/libopenssh-notary.a
+$(LIBNOTARY): always
+	(cd notary && $(MAKE))
+
 LIBCOMPAT=openbsd-compat/libopenbsd-compat.a
 $(LIBCOMPAT): always
 	(cd openbsd-compat && $(MAKE))
@@ -138,8 +142,8 @@
 	$(AR) rv $@ $(LIBSSH_OBJS)
 	$(RANLIB) $@
 
-ssh$(EXEEXT): $(LIBCOMPAT) libssh.a $(SSHOBJS)
-	$(LD) -o $@ $(SSHOBJS) $(LDFLAGS) -lssh -lopenbsd-compat $(SSHLIBS) $(LIBS)
+ssh$(EXEEXT): $(LIBCOMPAT) $(LIBNOTARY) libssh.a $(SSHOBJS)
+	$(LD) -o $@ $(SSHOBJS) $(LDFLAGS) -lssh -lopenbsd-compat -lopenssh-notary -lssl $(SSHLIBS) $(LIBS)
 
 sshd$(EXEEXT): libssh.a	$(LIBCOMPAT) $(SSHDOBJS)
 	$(LD) -o $@ $(SSHDOBJS) $(LDFLAGS) -lssh -lopenbsd-compat $(SSHDLIBS) $(LIBS)
@@ -199,6 +203,7 @@
 	rm -f *.o *.a $(TARGETS) logintest config.cache config.log
 	rm -f *.out core survey
 	(cd openbsd-compat && $(MAKE) clean)
+	(cd notary && $(MAKE) clean)
 
 distclean:	regressclean
 	rm -f *.o *.a $(TARGETS) logintest config.cache config.log
@@ -207,6 +212,7 @@
 	rm -f survey.sh openbsd-compat/regress/Makefile *~ 
 	rm -rf autom4te.cache
 	(cd openbsd-compat && $(MAKE) distclean)
+	(cd notary && $(MAKE) distclean)
 	if test -d pkg ; then \
 		rm -fr pkg ; \
 	fi
diff -r c3f49c169c97 -r 6b9e8012c1d0 config.h.in
--- a/config.h.in	Sun Oct 07 12:55:03 2012 +0200
+++ b/config.h.in	Mon Dec 24 16:28:45 2012 +0100
@@ -1529,6 +1529,11 @@
 /* Define if xauth is found in your path */
 #undef XAUTH_PATH
 
+/* Enable large inode numbers on Mac OS X 10.5.  */
+#ifndef _DARWIN_USE_64_BIT_INODE
+# define _DARWIN_USE_64_BIT_INODE 1
+#endif
+
 /* Number of bits in a file offset, on hosts where this is settable. */
 #undef _FILE_OFFSET_BITS
 
diff -r c3f49c169c97 -r 6b9e8012c1d0 configure
--- a/configure	Sun Oct 07 12:55:03 2012 +0200
+++ b/configure	Mon Dec 24 16:28:45 2012 +0100
@@ -1,14 +1,12 @@
 #! /bin/sh
 # From configure.ac Revision: 1.496 .
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.68 for OpenSSH Portable.
+# Generated by GNU Autoconf 2.69 for OpenSSH Portable.
 #
 # Report bugs to <openssh-unix-dev@mindrot.org>.
 #
 #
-# Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
-# 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010 Free Software
-# Foundation, Inc.
+# Copyright (C) 1992-1996, 1998-2012 Free Software Foundation, Inc.
 #
 #
 # This configure script is free software; the Free Software Foundation
@@ -137,6 +135,31 @@
 # CDPATH.
 (unset CDPATH) >/dev/null 2>&1 && unset CDPATH
 
+# Use a proper internal environment variable to ensure we don't fall
+  # into an infinite loop, continuously re-executing ourselves.
+  if test x"${_as_can_reexec}" != xno && test "x$CONFIG_SHELL" != x; then
+    _as_can_reexec=no; export _as_can_reexec;
+    # We cannot yet assume a decent shell, so we have to provide a
+# neutralization value for shells without unset; and this also
+# works around shells that cannot unset nonexistent variables.
+# Preserve -v and -x to the replacement shell.
+BASH_ENV=/dev/null
+ENV=/dev/null
+(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
+case $- in # ((((
+  *v*x* | *x*v* ) as_opts=-vx ;;
+  *v* ) as_opts=-v ;;
+  *x* ) as_opts=-x ;;
+  * ) as_opts= ;;
+esac
+exec $CONFIG_SHELL $as_opts "$as_myself" ${1+"$@"}
+# Admittedly, this is quite paranoid, since all the known shells bail
+# out after a failed `exec'.
+$as_echo "$0: could not re-execute with $CONFIG_SHELL" >&2
+as_fn_exit 255
+  fi
+  # We don't want this to propagate to other subprocesses.
+          { _as_can_reexec=; unset _as_can_reexec;}
 if test "x$CONFIG_SHELL" = x; then
   as_bourne_compatible="if test -n \"\${ZSH_VERSION+set}\" && (emulate sh) >/dev/null 2>&1; then :
   emulate sh
@@ -170,7 +193,8 @@
 else
   exitcode=1; echo positional parameters were not saved.
 fi
-test x\$exitcode = x0 || exit 1"
+test x\$exitcode = x0 || exit 1
+test -x / || exit 1"
   as_suggested="  as_lineno_1=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_1a=\$LINENO
   as_lineno_2=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_2a=\$LINENO
   eval 'test \"x\$as_lineno_1'\$as_run'\" != \"x\$as_lineno_2'\$as_run'\" &&
@@ -215,21 +239,25 @@
 
 
       if test "x$CONFIG_SHELL" != x; then :
-  # We cannot yet assume a decent shell, so we have to provide a
-	# neutralization value for shells without unset; and this also
-	# works around shells that cannot unset nonexistent variables.
-	# Preserve -v and -x to the replacement shell.
-	BASH_ENV=/dev/null
-	ENV=/dev/null
-	(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
-	export CONFIG_SHELL
-	case $- in # ((((
-	  *v*x* | *x*v* ) as_opts=-vx ;;
-	  *v* ) as_opts=-v ;;
-	  *x* ) as_opts=-x ;;
-	  * ) as_opts= ;;
-	esac
-	exec "$CONFIG_SHELL" $as_opts "$as_myself" ${1+"$@"}
+  export CONFIG_SHELL
+             # We cannot yet assume a decent shell, so we have to provide a
+# neutralization value for shells without unset; and this also
+# works around shells that cannot unset nonexistent variables.
+# Preserve -v and -x to the replacement shell.
+BASH_ENV=/dev/null
+ENV=/dev/null
+(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
+case $- in # ((((
+  *v*x* | *x*v* ) as_opts=-vx ;;
+  *v* ) as_opts=-v ;;
+  *x* ) as_opts=-x ;;
+  * ) as_opts= ;;
+esac
+exec $CONFIG_SHELL $as_opts "$as_myself" ${1+"$@"}
+# Admittedly, this is quite paranoid, since all the known shells bail
+# out after a failed `exec'.
+$as_echo "$0: could not re-execute with $CONFIG_SHELL" >&2
+exit 255
 fi
 
     if test x$as_have_required = xno; then :
@@ -332,6 +360,14 @@
 
 
 } # as_fn_mkdir_p
+
+# as_fn_executable_p FILE
+# -----------------------
+# Test if FILE is an executable regular file.
+as_fn_executable_p ()
+{
+  test -f "$1" && test -x "$1"
+} # as_fn_executable_p
 # as_fn_append VAR VALUE
 # ----------------------
 # Append the text in VALUE to the end of the definition contained in VAR. Take
@@ -453,6 +489,10 @@
   chmod +x "$as_me.lineno" ||
     { $as_echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2; as_fn_exit 1; }
 
+  # If we had to re-execute with $CONFIG_SHELL, we're ensured to have
+  # already done that, so ensure we don't try to do so again and fall
+  # in an infinite loop.  This has already happened in practice.
+  _as_can_reexec=no; export _as_can_reexec
   # Don't try to exec as it changes $[0], causing all sort of problems
   # (the dirname of $[0] is not the place where we might find the
   # original and so on.  Autoconf is especially sensitive to this).
@@ -487,16 +527,16 @@
     # ... but there are two gotchas:
     # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
     # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
-    # In both cases, we have to default to `cp -p'.
+    # In both cases, we have to default to `cp -pR'.
     ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
-      as_ln_s='cp -p'
+      as_ln_s='cp -pR'
   elif ln conf$$.file conf$$ 2>/dev/null; then
     as_ln_s=ln
   else
-    as_ln_s='cp -p'
-  fi
-else
-  as_ln_s='cp -p'
+    as_ln_s='cp -pR'
+  fi
+else
+  as_ln_s='cp -pR'
 fi
 rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
 rmdir conf$$.dir 2>/dev/null
@@ -508,28 +548,8 @@
   as_mkdir_p=false
 fi
 
-if test -x / >/dev/null 2>&1; then
-  as_test_x='test -x'
-else
-  if ls -dL / >/dev/null 2>&1; then
-    as_ls_L_option=L
-  else
-    as_ls_L_option=
-  fi
-  as_test_x='
-    eval sh -c '\''
-      if test -d "$1"; then
-	test -d "$1/.";
-      else
-	case $1 in #(
-	-*)set "./$1";;
-	esac;
-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
-	???[sx]*):;;*)false;;esac;fi
-    '\'' sh
-  '
-fi
-as_executable_p=$as_test_x
+as_test_x='test -x'
+as_executable_p=as_fn_executable_p
 
 # Sed expression to map a string onto a valid CPP name.
 as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
@@ -1223,8 +1243,6 @@
 if test "x$host_alias" != x; then
   if test "x$build_alias" = x; then
     cross_compiling=maybe
-    $as_echo "$as_me: WARNING: if you wanted to set the --build type, don't use --host.
-    If a cross compiler is detected then cross compile mode will be used" >&2
   elif test "x$build_alias" != "x$host_alias"; then
     cross_compiling=yes
   fi
@@ -1516,9 +1534,9 @@
 if $ac_init_version; then
   cat <<\_ACEOF
 OpenSSH configure Portable
-generated by GNU Autoconf 2.68
-
-Copyright (C) 2010 Free Software Foundation, Inc.
+generated by GNU Autoconf 2.69
+
+Copyright (C) 2012 Free Software Foundation, Inc.
 This configure script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it.
 _ACEOF
@@ -1750,7 +1768,7 @@
 	 test ! -s conftest.err
        } && test -s conftest$ac_exeext && {
 	 test "$cross_compiling" = yes ||
-	 $as_test_x conftest$ac_exeext
+	 test -x conftest$ac_exeext
        }; then :
   ac_retval=0
 else
@@ -1998,7 +2016,8 @@
 main ()
 {
 static int test_array [1 - 2 * !(($2) >= 0)];
-test_array [0] = 0
+test_array [0] = 0;
+return test_array [0];
 
   ;
   return 0;
@@ -2014,7 +2033,8 @@
 main ()
 {
 static int test_array [1 - 2 * !(($2) <= $ac_mid)];
-test_array [0] = 0
+test_array [0] = 0;
+return test_array [0];
 
   ;
   return 0;
@@ -2040,7 +2060,8 @@
 main ()
 {
 static int test_array [1 - 2 * !(($2) < 0)];
-test_array [0] = 0
+test_array [0] = 0;
+return test_array [0];
 
   ;
   return 0;
@@ -2056,7 +2077,8 @@
 main ()
 {
 static int test_array [1 - 2 * !(($2) >= $ac_mid)];
-test_array [0] = 0
+test_array [0] = 0;
+return test_array [0];
 
   ;
   return 0;
@@ -2090,7 +2112,8 @@
 main ()
 {
 static int test_array [1 - 2 * !(($2) <= $ac_mid)];
-test_array [0] = 0
+test_array [0] = 0;
+return test_array [0];
 
   ;
   return 0;
@@ -2220,7 +2243,7 @@
 running configure, to aid debugging if configure makes a mistake.
 
 It was created by OpenSSH $as_me Portable, which was
-generated by GNU Autoconf 2.68.  Invocation command line was
+generated by GNU Autoconf 2.69.  Invocation command line was
 
   $ $0 $@
 
@@ -2600,7 +2623,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="${ac_tool_prefix}gcc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -2640,7 +2663,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_CC="gcc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -2693,7 +2716,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="${ac_tool_prefix}cc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -2734,7 +2757,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     if test "$as_dir/$ac_word$ac_exec_ext" = "/usr/ucb/cc"; then
        ac_prog_rejected=yes
        continue
@@ -2792,7 +2815,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="$ac_tool_prefix$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -2836,7 +2859,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_CC="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3282,8 +3305,7 @@
 /* end confdefs.h.  */
 #include <stdarg.h>
 #include <stdio.h>
-#include <sys/types.h>
-#include <sys/stat.h>
+struct stat;
 /* Most of the following tests are stolen from RCS 5.7's src/conf.sh.  */
 struct buf { int x; };
 FILE * (*rcsopen) (struct buf *, struct stat *, int);
@@ -3623,7 +3645,7 @@
     for ac_prog in grep ggrep; do
     for ac_exec_ext in '' $ac_executable_extensions; do
       ac_path_GREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_GREP" && $as_test_x "$ac_path_GREP"; } || continue
+      as_fn_executable_p "$ac_path_GREP" || continue
 # Check for GNU ac_path_GREP and select it if it is found.
   # Check for GNU $ac_path_GREP
 case `"$ac_path_GREP" --version 2>&1` in
@@ -3689,7 +3711,7 @@
     for ac_prog in egrep; do
     for ac_exec_ext in '' $ac_executable_extensions; do
       ac_path_EGREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_EGREP" && $as_test_x "$ac_path_EGREP"; } || continue
+      as_fn_executable_p "$ac_path_EGREP" || continue
 # Check for GNU ac_path_EGREP and select it if it is found.
   # Check for GNU $ac_path_EGREP
 case `"$ac_path_EGREP" --version 2>&1` in
@@ -4110,7 +4132,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_AWK="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4288,7 +4310,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_RANLIB="${ac_tool_prefix}ranlib"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4328,7 +4350,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_RANLIB="ranlib"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4400,7 +4422,7 @@
     # by default.
     for ac_prog in ginstall scoinst install; do
       for ac_exec_ext in '' $ac_executable_extensions; do
-	if { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; }; then
+	if as_fn_executable_p "$as_dir/$ac_prog$ac_exec_ext"; then
 	  if test $ac_prog = install &&
 	    grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
 	    # AIX install.  It has an incompatible calling convention.
@@ -4475,7 +4497,7 @@
     for ac_prog in egrep; do
     for ac_exec_ext in '' $ac_executable_extensions; do
       ac_path_EGREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_EGREP" && $as_test_x "$ac_path_EGREP"; } || continue
+      as_fn_executable_p "$ac_path_EGREP" || continue
 # Check for GNU ac_path_EGREP and select it if it is found.
   # Check for GNU $ac_path_EGREP
 case `"$ac_path_EGREP" --version 2>&1` in
@@ -4541,7 +4563,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_AR="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4581,7 +4603,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_CAT="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4621,7 +4643,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_KILL="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4663,7 +4685,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_PERL="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4706,7 +4728,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_SED="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4747,7 +4769,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_ENT="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4788,7 +4810,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_TEST_MINUS_S_SH="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4828,7 +4850,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_TEST_MINUS_S_SH="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4868,7 +4890,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_TEST_MINUS_S_SH="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4908,7 +4930,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_SH="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4948,7 +4970,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_GROFF="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4988,7 +5010,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_NROFF="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5028,7 +5050,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_MANDOC="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5084,7 +5106,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_PATH_GROUPADD_PROG="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5125,7 +5147,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_PATH_USERADD_PROG="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5164,7 +5186,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_MAKE_PACKAGE_SUPPORTED="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5391,6 +5413,8 @@
 esac
 rm -rf conftest*
   fi
+
+
 fi
 
 
@@ -5425,7 +5449,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_LOGIN_PROGRAM_FALLBACK="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5473,7 +5497,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_PATH_PASSWD_PROG="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -9157,7 +9181,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_PKGCONFIG="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -9200,7 +9224,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_ac_pt_PKGCONFIG="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -15146,7 +15170,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_KRB5CONF="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -15677,7 +15701,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_xauth_path="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -15960,7 +15984,7 @@
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_NROFF="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -16749,7 +16773,7 @@
 
 
 
-ac_config_files="$ac_config_files Makefile buildpkg.sh opensshd.init openssh.xml openbsd-compat/Makefile openbsd-compat/regress/Makefile survey.sh"
+ac_config_files="$ac_config_files Makefile buildpkg.sh opensshd.init openssh.xml openbsd-compat/Makefile openbsd-compat/regress/Makefile notary/Makefile survey.sh"
 
 cat >confcache <<\_ACEOF
 # This file is a shell script that caches the results of configure
@@ -17159,16 +17183,16 @@
     # ... but there are two gotchas:
     # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
     # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
-    # In both cases, we have to default to `cp -p'.
+    # In both cases, we have to default to `cp -pR'.
     ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
-      as_ln_s='cp -p'
+      as_ln_s='cp -pR'
   elif ln conf$$.file conf$$ 2>/dev/null; then
     as_ln_s=ln
   else
-    as_ln_s='cp -p'
-  fi
-else
-  as_ln_s='cp -p'
+    as_ln_s='cp -pR'
+  fi
+else
+  as_ln_s='cp -pR'
 fi
 rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
 rmdir conf$$.dir 2>/dev/null
@@ -17228,28 +17252,16 @@
   as_mkdir_p=false
 fi
 
-if test -x / >/dev/null 2>&1; then
-  as_test_x='test -x'
-else
-  if ls -dL / >/dev/null 2>&1; then
-    as_ls_L_option=L
-  else
-    as_ls_L_option=
-  fi
-  as_test_x='
-    eval sh -c '\''
-      if test -d "$1"; then
-	test -d "$1/.";
-      else
-	case $1 in #(
-	-*)set "./$1";;
-	esac;
-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
-	???[sx]*):;;*)false;;esac;fi
-    '\'' sh
-  '
-fi
-as_executable_p=$as_test_x
+
+# as_fn_executable_p FILE
+# -----------------------
+# Test if FILE is an executable regular file.
+as_fn_executable_p ()
+{
+  test -f "$1" && test -x "$1"
+} # as_fn_executable_p
+as_test_x='test -x'
+as_executable_p=as_fn_executable_p
 
 # Sed expression to map a string onto a valid CPP name.
 as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
@@ -17271,7 +17283,7 @@
 # values after options handling.
 ac_log="
 This file was extended by OpenSSH $as_me Portable, which was
-generated by GNU Autoconf 2.68.  Invocation command line was
+generated by GNU Autoconf 2.69.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
   CONFIG_HEADERS  = $CONFIG_HEADERS
@@ -17333,10 +17345,10 @@
 ac_cs_config="`$as_echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`"
 ac_cs_version="\\
 OpenSSH config.status Portable
-configured by $0, generated by GNU Autoconf 2.68,
+configured by $0, generated by GNU Autoconf 2.69,
   with options \\"\$ac_cs_config\\"
 
-Copyright (C) 2010 Free Software Foundation, Inc.
+Copyright (C) 2012 Free Software Foundation, Inc.
 This config.status script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it."
 
@@ -17426,7 +17438,7 @@
 _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 if \$ac_cs_recheck; then
-  set X '$SHELL' '$0' $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
+  set X $SHELL '$0' $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
   shift
   \$as_echo "running CONFIG_SHELL=$SHELL \$*" >&6
   CONFIG_SHELL='$SHELL'
@@ -17462,6 +17474,7 @@
     "openssh.xml") CONFIG_FILES="$CONFIG_FILES openssh.xml" ;;
     "openbsd-compat/Makefile") CONFIG_FILES="$CONFIG_FILES openbsd-compat/Makefile" ;;
     "openbsd-compat/regress/Makefile") CONFIG_FILES="$CONFIG_FILES openbsd-compat/regress/Makefile" ;;
+    "notary/Makefile") CONFIG_FILES="$CONFIG_FILES notary/Makefile" ;;
     "survey.sh") CONFIG_FILES="$CONFIG_FILES survey.sh" ;;
 
   *) as_fn_error $? "invalid argument: \`$ac_config_target'" "$LINENO" 5;;
diff -r c3f49c169c97 -r 6b9e8012c1d0 configure.ac
--- a/configure.ac	Sun Oct 07 12:55:03 2012 +0200
+++ b/configure.ac	Mon Dec 24 16:28:45 2012 +0100
@@ -4359,7 +4359,7 @@
 
 AC_EXEEXT
 AC_CONFIG_FILES([Makefile buildpkg.sh opensshd.init openssh.xml \
-	openbsd-compat/Makefile openbsd-compat/regress/Makefile \
+	openbsd-compat/Makefile openbsd-compat/regress/Makefile notary/Makefile \
 	survey.sh])
 AC_OUTPUT
 
diff -r c3f49c169c97 -r 6b9e8012c1d0 notary/Makefile.in
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/notary/Makefile.in	Mon Dec 24 16:28:45 2012 +0100
@@ -0,0 +1,37 @@
+# $Id: Makefile.in,v 1.48 2011/11/04 00:25:25 dtucker Exp $
+
+sysconfdir=@sysconfdir@
+piddir=@piddir@
+srcdir=@srcdir@
+top_srcdir=@top_srcdir@
+
+VPATH=@srcdir@
+CC=@CC@
+LD=@LD@
+CFLAGS=@CFLAGS@
+CPPFLAGS=-I. -I.. -I$(srcdir) -I$(srcdir)/.. @CPPFLAGS@ @DEFS@
+LIBS=@LIBS@
+AR=@AR@
+RANLIB=@RANLIB@
+INSTALL=@INSTALL@
+LDFLAGS=-L. @LDFLAGS@
+
+NOTARY=hostkeycheck.o sslcomm.o
+
+all: libopenssh-notary.a
+
+hostkeycheck.o: hostkeycheck.c hostkeycheck.h
+	$(CC) $(CFLAGS) $(CPPFLAGS) -c hostkeycheck.c
+
+sslcomm.o: sslcomm.c sslcomm.h
+	$(CC) $(CFLAGS) $(CPPFLAGS) -c sslcomm.c
+
+libopenssh-notary.a: $(NOTARY)
+	$(AR) rv $@ $(NOTARY)
+	$(RANLIB) $@
+
+clean:
+	rm -f *.o  
+
+distclean: clean
+	rm -f Makefile *~
diff -r c3f49c169c97 -r 6b9e8012c1d0 notary/hostkeycheck.c
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/notary/hostkeycheck.c	Mon Dec 24 16:28:45 2012 +0100
@@ -0,0 +1,63 @@
+/*
+ * hostkeycheck.c
+ *
+ *  Created on: Oct 6, 2012
+ *      Author: Oliver Gasser <gasser@in.tum.de>
+ */
+
+#include <stdio.h>
+#include <string.h>
+
+#include "hostkeycheck.h"
+#include "sslcomm.h"
+#include "../log.h"
+#include "../xmalloc.h"
+
+
+/**
+ * Checks if the host key fingerprint matches an entry in an online host key database.
+ * Returns 0 if fingerprint matches, 1 if it does not match and 2 if there is no entry in the DB.
+ */
+int
+check_fp_online(struct sockaddr_in *hostaddr, char *host, char *ip, char (*msg_ptr)[1024], char *msg1,
+		const char *type, char *fp, Options options, char *ra, char *msg2, Key *host_key)
+{
+
+	switch(execute_online_fp_check(hostaddr, host_key, fp)) {
+
+	case MATCH:
+		snprintf(*msg_ptr, sizeof(*msg_ptr),
+						"The authenticity of host '%.200s (%s)' was successfully "
+						"established via the online database at %s.%s\n"
+						"%s key fingerprint is %s.%s%s\n%s"
+						"Are you sure you want to continue connecting "
+						"(yes/no)? ",
+						host, ip, ONLINE_CHECK_HOST, msg1, type, fp,
+						options.visual_host_key ? "\n" : "",
+						options.visual_host_key ? ra : "",
+						msg2);
+		return MATCH;
+
+	case NO_MATCH:
+		error("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@");
+		error("@  WARNING: REMOTE HOST IDENTIFICATION DOES NOT MATCH DB! @");
+		error("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@");
+		error("IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!");
+		error("Someone could be eavesdropping on you right now (man-in-the-middle attack)!");
+		error("It is also possible that a host key has just been changed.");
+		error("The fingerprint for the %s key sent by the remote host is\n%s\nand does not match with the key in the online database.",
+			type, fp);
+		error("Please contact your system administrator.");
+		snprintf(*msg_ptr, sizeof(*msg_ptr),
+										"%sAre you sure you want to continue connecting "
+										"(yes/no)? ",
+										msg2);
+		return NO_MATCH;
+
+	case NO_ENTRY:
+	default:
+		/* Immediately return, snprintf() is done in sshconnect.c to avoid duplicate code. */
+		return NO_ENTRY;
+
+	}
+}
diff -r c3f49c169c97 -r 6b9e8012c1d0 notary/hostkeycheck.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/notary/hostkeycheck.h	Mon Dec 24 16:28:45 2012 +0100
@@ -0,0 +1,27 @@
+/*
+ * hostkeycheck.h
+ *
+ *  Created on: Oct 6, 2012
+ *      Author: Oliver Gasser <gasser@in.tum.de>
+ */
+#ifndef NOTARY_HOSTKEYCHECK_H
+#define NOTARY_HOSTKEYCHECK_H
+
+#include <netinet/in.h>
+#include <sys/types.h>		/* Needed by readconf.h */
+#include "../key.h"			/* Needed by readconf.h */
+#include "../log.h"			/* Needed by readconf.h */
+#include "../ssh.h"			/* Needed by readconf.h */
+#include "../readconf.h"
+
+
+enum fp_verify_results {
+	MATCH,
+	NO_MATCH,
+	NO_ENTRY
+};
+
+int check_fp_online(struct sockaddr_in *, char *, char *, char (*)[1024], char *, const char *, char *, Options options, char *, char *, Key *);
+
+
+#endif /* NOTARY_HOSTKEYCHECK_H */
diff -r c3f49c169c97 -r 6b9e8012c1d0 notary/sslcomm.c
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/notary/sslcomm.c	Mon Dec 24 16:28:45 2012 +0100
@@ -0,0 +1,275 @@
+/*
+ * sslcomm.c
+ *
+ *  Created on: Oct 8, 2012
+ *      Author: Oliver Gasser <gasser@in.tum.de>
+ */
+
+#include <openssl/ssl.h>
+#include <stdio.h>
+#include <string.h>
+#include <sys/socket.h>
+#include <netinet/in.h>
+#include <netdb.h>
+#include <stdlib.h>
+#include <inttypes.h>
+
+#include "sslcomm.h"
+#include "../xmalloc.h"
+
+
+SSL_CTX *ctx;
+SSL *ssl = NULL;
+int sock;
+
+
+int
+tcp_connect(char *host, int port)
+{
+	struct hostent *hp;
+	struct sockaddr_in addr;
+
+	hp = gethostbyname(host);
+
+	memset(&addr, 0, sizeof(addr));
+	addr.sin_addr = *(struct in_addr *) hp->h_addr_list[0];
+	addr.sin_family = AF_INET;
+	addr.sin_port = htons(port);
+
+	sock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
+
+	connect(sock, (struct sockaddr *) &addr, sizeof(addr));
+
+	return sock;
+}
+
+
+int
+init_ssl(char *host, int port)
+{
+
+	if (ctx != NULL && ssl != NULL) {
+		return -1;
+	}
+
+	// Initialize the SSL library
+	SSL_load_error_strings();
+	SSL_library_init();
+
+	// Create a context for TLS1 method
+	ctx = SSL_CTX_new(TLSv1_client_method());
+
+	// Create SSL object
+	ssl = SSL_new(ctx);
+
+	// Create TCP connection and associate it with the SSL connection
+	tcp_connect(host, port);
+	SSL_set_fd(ssl, sock);
+
+	// Do SSL handshake
+	SSL_connect(ssl);
+
+	return 0;
+}
+
+
+int
+finish_ssl(void)
+{
+
+	if (ctx == NULL && ssl == NULL) {
+		return -1;
+	}
+
+	// Shutdown the SSL connection
+	SSL_shutdown(ssl);
+
+	// Free objects
+	SSL_free(ssl);
+	SSL_CTX_free(ctx);
+
+	shutdown(sock, -2);
+
+	return 0;
+}
+
+
+int
+count_digits(int number)
+{
+	int i = 1;
+	for (; number > 0; i++) {
+		number /= 10;
+	}
+	return i;
+}
+
+
+char *
+build_http_post(struct sockaddr_in *hostaddr, Key *host_key, char *fp, int *post_len_ptr)
+{
+	/////////////////////////////////////////////////
+	// MESSAGE_TYPE_FP_VERIFY_REQUEST format:      //
+	/////////////////////////////////////////////////
+	// | T | L | V | IP | P | K | N |   FP ...   | //
+	/////////////////////////////////////////////////
+	// T  = Message type (1 Byte) = 50             //
+	// L  = Message length in bytes (2 Bytes)      //
+	// V  = Message format version (1 Byte) = 1    //
+	// IP = IPv4 address of queried host (4 Bytes) //
+	// P  = Port number of queried host (2 Bytes)  //
+	// K  = Keytype of queried host (1 Byte)       //
+	// N  = NID of ECDSA type keys (2 Bytes)       //
+	// FP = Fingerprint of queried host (variable) //
+	/////////////////////////////////////////////////
+
+	// Build MESSAGE_TYPE_FP_VERIFY_REQUEST message
+	uint16_t message_len = 1 + 2 + 1 + 4 + 2 + 1 + 2 + strlen(fp);
+	char *message = xmalloc(message_len);
+
+	message[0] = (uint8_t) MESSAGE_TYPE_FP_VERIFY_REQUEST;
+	uint16_t message_len_network = htons(message_len);
+	memcpy(&message[1], &message_len_network, sizeof(message_len_network));
+	message[3] = (uint8_t) MESSAGE_TYPE_FP_VERIFY_REQUEST_FORMAT_VERSION;
+	memcpy(&message[4], &hostaddr->sin_addr.s_addr, sizeof(hostaddr->sin_addr.s_addr));
+	memcpy(&message[8], &hostaddr->sin_port, sizeof(hostaddr->sin_port));
+	message[10] = (uint8_t) host_key->type;
+	uint16_t nid_network = htons(host_key->ecdsa_nid);
+	memcpy(&message[11], &nid_network, sizeof(nid_network));
+	memcpy(&message[13], fp, strlen(fp));
+
+	/*
+	POST /url HTTP/1.0
+	Content-Type: application/octet-stream
+	Content-Length: NNN
+
+	MESSAGE_TYPE_FP_VERIFY_REQUEST
+	*/
+
+	// Build HTTP POST
+	*post_len_ptr = strlen("POST ") + strlen(ONLINE_CHECK_URL) + strlen("HTTP/1.0\r\nContent-Type: application/octet-stream\r\nContent-Length: ")
+			+ count_digits(message_len) + strlen("\r\n\r\n") + message_len;
+	char *post = xmalloc(*post_len_ptr);
+	snprintf(post, *post_len_ptr, "POST %s HTTP/1.0\r\nContent-Type: application/octet-stream\r\nContent-Length: %u\r\n\r\n", ONLINE_CHECK_URL, message_len);
+	memcpy(post + *post_len_ptr - message_len, message, message_len);
+
+	// Clean up
+	xfree(message);
+
+	return post;
+}
+
+
+/**
+ * @return 1 if the server's SSL certificate is valid, 0 otherwise
+ */
+int
+verify_cert(SSL *ssl)
+{
+	X509 *cert = SSL_get_peer_certificate(ssl);
+	size_t peer_sha1_len = sizeof(cert->sha1_hash)*2;
+	char *peer_sha1 = xmalloc(peer_sha1_len + 1);
+
+	unsigned int i;
+	for (i = 0; i < peer_sha1_len; i += 2) {
+		snprintf(&peer_sha1[i], 3, "%02x", cert->sha1_hash[i/2]);
+	}
+
+	int certs_match = (strcasecmp(peer_sha1, ONLINE_CHECK_SSL_FP) == 0);
+
+	// Cleanup
+	X509_free(cert);
+	xfree(peer_sha1);
+
+	return certs_match;
+}
+
+/**
+ * @return -1 if message is not valid, result in message otherwise
+ */
+int
+parse_response(char *response, int response_len)
+{
+	// Check if response is correct
+	char *line = strtok(response, "\n");
+
+	// HTTP/1.1 200 OK
+	if (strncmp(line, "HTTP/1.", strlen("HTTP/1.")) == 1 || (line[7] != '0' && line[7] != '1') ||
+			strncmp(&line[8], " 200 OK", strlen(" 200 OK")) == 1) {
+		return -1;
+	}
+
+	for (line = strtok(NULL, "\n"); line != NULL; line = strtok(NULL, "\n")) {
+		// Content-Type: application/octet-stream
+		if (strncmp(line, "Content-Type:", strlen("Content-Type:")) == 0 &&
+				strncmp(&line[13], " application/octet-stream", strlen(" application/octet-stream") == 1)) {
+			return -1;
+		}
+
+		// Empty line -> content starts now
+		if (strlen(line) <= 1) {
+			break;
+		}
+	}
+
+	/////////////////////////////////////////////////
+	// MESSAGE_TYPE_FP_VERIFY_RESULT format:       //
+	/////////////////////////////////////////////////
+	// | T | L | V | R |                           //
+	/////////////////////////////////////////////////
+	// T  = Message type (1 Byte) = 60             //
+	// L  = Message length in bytes (2 Bytes)      //
+	// V  = Message format version (1 Byte) = 1    //
+	// R  = Result of verify request (1 Byte)      //
+	/////////////////////////////////////////////////
+
+	char *message = line + strlen(line) + 1;
+
+	uint8_t msg_type = message[0];
+	uint16_t msg_len_network;
+	memcpy(&msg_len_network, &message[1], sizeof(msg_len_network));
+	uint8_t msg_format = message[3];
+	uint8_t result = message[4];
+
+	if (msg_type != MESSAGE_TYPE_FP_VERIFY_RESULT
+			|| ntohs(msg_len_network) != response_len - (message - response)
+			|| msg_format != MESSAGE_TYPE_FP_VERIFY_RESULT_FORMAT_VERSION) {
+		return -1;
+	}
+
+	return result;
+}
+
+int
+execute_online_fp_check(struct sockaddr_in *hostaddr, Key *host_key, char *fp)
+{
+	init_ssl(ONLINE_CHECK_HOST, ONLINE_CHECK_PORT);
+
+	// Verify certificate
+	if (!verify_cert(ssl)) {
+		printf("Invalid SSL server cert!\n");
+		finish_ssl();
+		return -1;
+	}
+
+	// Create HTTP POST
+	int post_len;
+	char *post = build_http_post(hostaddr, host_key, fp, &post_len);
+
+	// Send request
+	SSL_write(ssl, post, post_len);
+	xfree(post);
+
+	// Get response message
+	char *response = xmalloc(MAX_VERIFY_RESULT_LENGTH);
+	int response_len = SSL_read(ssl, response, MAX_VERIFY_RESULT_LENGTH);
+
+	finish_ssl();
+
+	// Parse and verify message, extract result
+	int result = parse_response(response, response_len);
+
+	xfree(response);
+
+	return result;
+}
diff -r c3f49c169c97 -r 6b9e8012c1d0 notary/sslcomm.h
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/notary/sslcomm.h	Mon Dec 24 16:28:45 2012 +0100
@@ -0,0 +1,55 @@
+/*
+ * sslcomm.h
+ *
+ *  Created on: Oct 9, 2012
+ *      Author: Oliver Gasser <gasser@in.tum.de>
+ */
+
+#ifndef NOTARY_SSLCOMM_H
+#define NOTARY_SSLCOMM_H
+
+#include <stdint.h>
+#include <netinet/in.h>
+#include "../key.h"
+
+#define ONLINE_CHECK_HOST		"bozen.net.in.tum.de"
+#define ONLINE_CHECK_PORT		8443
+#define ONLINE_CHECK_SSL_FP		"3e831e06d352852f0494e13a065605c3c0f80f8d"
+#define ONLINE_CHECK_URL		"/Crossbear/VerifyFp"
+#define MESSAGE_TYPE_FP_VERIFY_REQUEST	50
+#define MESSAGE_TYPE_FP_VERIFY_RESULT	60
+#define MESSAGE_TYPE_FP_VERIFY_REQUEST_FORMAT_VERSION 1
+#define MESSAGE_TYPE_FP_VERIFY_RESULT_FORMAT_VERSION 1
+#define MAX_VERIFY_RESULT_LENGTH 10000
+
+/////////////////////////////////////////////////
+// MESSAGE_TYPE_FP_VERIFY_REQUEST format:      //
+/////////////////////////////////////////////////
+// | T | L | V | IP | P | K | N |   FP ...   | //
+/////////////////////////////////////////////////
+// T  = Message type (1 Byte) = 50             //
+// L  = Message length in bytes (2 Bytes)      //
+// V  = Message format version (1 Byte) = 1    //
+// IP = IPv4 address of queried host (4 Bytes) //
+// P  = Port number of queried host (2 Bytes)  //
+// K  = Keytype of queried host (1 Byte)       //
+// N  = NID of ECDSA type keys (2 Bytes)       //
+// FP = Fingerprint of queried host (variable) //
+/////////////////////////////////////////////////
+
+
+/////////////////////////////////////////////////
+// MESSAGE_TYPE_FP_VERIFY_RESULT format:       //
+/////////////////////////////////////////////////
+// | T | L | V | R |                           //
+/////////////////////////////////////////////////
+// T  = Message type (1 Byte) = 60             //
+// L  = Message length in bytes (2 Bytes)      //
+// V  = Message format version (1 Byte) = 1    //
+// R  = Result of verify request (1 Byte)      //
+/////////////////////////////////////////////////
+
+
+int execute_online_fp_check(struct sockaddr_in *, Key *, char *);
+
+#endif /* NOTARY_SSLCOMM_H */
diff -r c3f49c169c97 -r 6b9e8012c1d0 readconf.c
--- a/readconf.c	Sun Oct 07 12:55:03 2012 +0200
+++ b/readconf.c	Mon Dec 24 16:28:45 2012 +0100
@@ -134,7 +134,7 @@
 	oHashKnownHosts,
 	oTunnel, oTunnelDevice, oLocalCommand, oPermitLocalCommand,
 	oVisualHostKey, oUseRoaming, oZeroKnowledgePasswordAuthentication,
-	oKexAlgorithms, oIPQoS, oRequestTTY,
+	oKexAlgorithms, oIPQoS, oRequestTTY, oVerifyHostKeyNotary,
 	oDeprecated, oUnsupported
 } OpCodes;
 
@@ -246,6 +246,7 @@
 	{ "kexalgorithms", oKexAlgorithms },
 	{ "ipqos", oIPQoS },
 	{ "requesttty", oRequestTTY },
+	{ "verifyhostkeynotary", oVerifyHostKeyNotary },
 
 	{ NULL, oBadOption }
 };
@@ -1044,6 +1045,10 @@
 			*intptr = value;
 		break;
 
+	case oVerifyHostKeyNotary:
+		intptr = &options->verify_host_key_notary;
+		goto parse_flag;
+
 	case oDeprecated:
 		debug("%s line %d: Deprecated option \"%s\"",
 		    filename, linenum, keyword);
@@ -1203,6 +1208,7 @@
 	options->ip_qos_interactive = -1;
 	options->ip_qos_bulk = -1;
 	options->request_tty = -1;
+	options->verify_host_key_notary = -1;
 }
 
 /*
@@ -1367,6 +1373,8 @@
 		options->ip_qos_bulk = IPTOS_THROUGHPUT;
 	if (options->request_tty == -1)
 		options->request_tty = REQUEST_TTY_AUTO;
+	if (options->verify_host_key_notary == -1)
+		options->verify_host_key_notary = 0;
 	/* options->local_command should not be set by default */
 	/* options->proxy_command should not be set by default */
 	/* options->user will be set in the main program if appropriate */
diff -r c3f49c169c97 -r 6b9e8012c1d0 readconf.h
--- a/readconf.h	Sun Oct 07 12:55:03 2012 +0200
+++ b/readconf.h	Mon Dec 24 16:28:45 2012 +0100
@@ -135,6 +135,8 @@
 	int	use_roaming;
 
 	int	request_tty;
+
+	int verify_host_key_notary;
 }       Options;
 
 #define SSHCTL_MASTER_NO	0
diff -r c3f49c169c97 -r 6b9e8012c1d0 ssh.0
--- a/ssh.0	Sun Oct 07 12:55:03 2012 +0200
+++ b/ssh.0	Mon Dec 24 16:28:45 2012 +0100
@@ -282,6 +282,7 @@
                    User
                    UserKnownHostsFile
                    VerifyHostKeyDNS
+                   VerifyHostKeyNotary
                    VisualHostKey
                    XAuthLocation
 
diff -r c3f49c169c97 -r 6b9e8012c1d0 ssh.1
--- a/ssh.1	Sun Oct 07 12:55:03 2012 +0200
+++ b/ssh.1	Mon Dec 24 16:28:45 2012 +0100
@@ -475,6 +475,7 @@
 .It User
 .It UserKnownHostsFile
 .It VerifyHostKeyDNS
+.It VerifyHostKeyNotary
 .It VisualHostKey
 .It XAuthLocation
 .El
diff -r c3f49c169c97 -r 6b9e8012c1d0 ssh.c
--- a/ssh.c	Sun Oct 07 12:55:03 2012 +0200
+++ b/ssh.c	Mon Dec 24 16:28:45 2012 +0100
@@ -196,7 +196,7 @@
 usage(void)
 {
 	fprintf(stderr,
-"usage: ssh [-1246AaCfgKkMNnqsTtVvXxYy] [-b bind_address] [-c cipher_spec]\n"
+"usage: ssh [-1246AaCfgKkMNnqsTtVvXxYyZ] [-b bind_address] [-c cipher_spec]\n"
 "           [-D [bind_address:]port] [-e escape_char] [-F configfile]\n"
 "           [-I pkcs11] [-i identity_file]\n"
 "           [-L [bind_address:]port:host:hostport]\n"
@@ -326,7 +326,7 @@
 
  again:
 	while ((opt = getopt(ac, av, "1246ab:c:e:fgi:kl:m:no:p:qstvx"
-	    "ACD:F:I:KL:MNO:PR:S:TVw:W:XYy")) != -1) {
+	    "ACD:F:I:KL:MNO:PR:S:TVw:W:XYyZ")) != -1) {
 		switch (opt) {
 		case '1':
 			options.protocol = SSH_PROTO_1;
@@ -360,6 +360,9 @@
 			options.forward_x11 = 1;
 			options.forward_x11_trusted = 1;
 			break;
+		case 'Z':
+			options.verify_host_key_notary = 1;
+			break;
 		case 'g':
 			options.gateway_ports = 1;
 			break;
diff -r c3f49c169c97 -r 6b9e8012c1d0 ssh_config.0
--- a/ssh_config.0	Sun Oct 07 12:55:03 2012 +0200
+++ b/ssh_config.0	Mon Dec 24 16:28:45 2012 +0100
@@ -704,6 +704,12 @@
              version 2 only.
 
              See also VERIFYING HOST KEYS in ssh(1).
+             
+     VerifyHostKeyNotary
+             Specifies whether to verify the remote key at a host key hotary
+             service when seeing an unknown or changed host key.
+             The argument to this keyword must be ``yes'', or ``no''. The
+             default is ``no''.
 
      VisualHostKey
              If this flag is set to ``yes'', an ASCII art representation of
diff -r c3f49c169c97 -r 6b9e8012c1d0 ssh_config.5
--- a/ssh_config.5	Sun Oct 07 12:55:03 2012 +0200
+++ b/ssh_config.5	Mon Dec 24 16:28:45 2012 +0100
@@ -1211,6 +1211,15 @@
 .Sx VERIFYING HOST KEYS
 in
 .Xr ssh 1 .
+.It Cm VerifyHostKeyNotary
+Specifies whether to verify the remote key at a host key hotary service
+when seeing an unknown or changed host key.
+The argument to this keyword must be
+.Dq yes
+or
+.Dq no .
+The default is
+.Dq no .
 .It Cm VisualHostKey
 If this flag is set to
 .Dq yes ,
diff -r c3f49c169c97 -r 6b9e8012c1d0 sshconnect.c
--- a/sshconnect.c	Sun Oct 07 12:55:03 2012 +0200
+++ b/sshconnect.c	Mon Dec 24 16:28:45 2012 +0100
@@ -62,6 +62,8 @@
 #include "ssh2.h"
 #include "version.h"
 
+#include "notary/hostkeycheck.h"
+
 char *client_version_string = NULL;
 char *server_version_string = NULL;
 
@@ -860,16 +862,29 @@
 					    "No matching host key fingerprint"
 					    " found in DNS.\n");
 			}
-			snprintf(msg, sizeof(msg),
-			    "The authenticity of host '%.200s (%s)' can't be "
-			    "established%s\n"
-			    "%s key fingerprint is %s.%s%s\n%s"
-			    "Are you sure you want to continue connecting "
-			    "(yes/no)? ",
-			    host, ip, msg1, type, fp,
-			    options.visual_host_key ? "\n" : "",
-			    options.visual_host_key ? ra : "",
-			    msg2);
+
+			/* Default result is no entry, also if online fingerprint check is disabled. */
+			int online_check_result = NO_ENTRY;
+
+			if (!local && hostaddr->sa_family == AF_INET && options.verify_host_key_notary) {
+				online_check_result = check_fp_online((struct sockaddr_in *) hostaddr, host, ip, &msg, msg1, type,
+						fp, options, ra, msg2, host_key);
+			}
+
+			/* Is true if the online check was disabled or it returned no matching fingerprint */
+			if (online_check_result == NO_ENTRY) {
+				snprintf(msg, sizeof(msg),
+						"The authenticity of host '%.200s (%s)' can't be "
+						"established%s\n"
+						"%s key fingerprint is %s.%s%s\n%s"
+						"Are you sure you want to continue connecting "
+						"(yes/no)? ",
+						host, ip, msg1, type, fp,
+						options.visual_host_key ? "\n" : "",
+						options.visual_host_key ? ra : "",
+						msg2);
+			}
+
 			xfree(ra);
 			xfree(fp);
 			if (!confirm(msg))
